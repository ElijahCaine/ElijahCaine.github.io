<!DOCTYPE html>
<html lang="en">
<head>
        <title>elijahcaine.me</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
        <link href="elijahcaine.me/atom.xml" type="application/atom+xml" rel="alternate" title="elijahcaine.me ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body>

        <!-- header>
            <nav>
                <ul>
                    <li><a href="./about/">About</a> ::</li>
                    <li><a href="./contact/">Contact</a></li>
                    <li>:: <a href="./categories.html">Categories</a></li>
                    <li>:: <a href="./tags.html">Tags</a></li>
                </ul>
            </nav>
        </header -->

        
        

            <header>
                <h1><a href="." id="site-title">elijahcaine.me </a> : <a href="./tech/kubernetes-as-an-external-service-proxy" id="page-title">Kubernetes as an external service proxy</a></h1>
<time datetime="2018-10-13T00:00:00-07:00">Sat 13 October 2018</time>            </header>

            <article>
                <p>Say you have a firewall restriction that creates the following situation:</p>
<ol class="arabic simple">
<li>App1 cannot communicate directly with App2.</li>
<li>App1 and App2 can both talk to a Kubernets cluster.</li>
<li>Neither app is hosted on the Kubernetes cluster.</li>
<li>How can you get messages between App1 and App2?</li>
</ol>
<p>The way the problem is stated makes it pretty obvious that the solution <em>involves</em> using a Kubernetes cluster, but how exactly?</p>
<p>The naive solution might be to spin up a container which acts as a proxy; Nginx comes to mind.
This would definitely work, but I am exceedingly lazy and don't want to learn how to configure Nginx.
In fact, the solution I came to doesn't involve running any new pods!</p>
<p>Here's the code.
Below I'll explain what's happening here and why it works.</p>
<pre class="code yaml literal-block">
<span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Endpoints</span>
<span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myapp-proxy</span>
<span class="l-Scalar-Plain">subsets</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">addresses</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ip</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2.3.4.5k</span> <span class="c1"># App2's address</span>
  <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080</span> <span class="c1"># App2's service port</span>
<span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>

<span class="nn">---</span>

<span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Service</span>
<span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myapp-proxy</span>
<span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">LoadBalancer</span>
  <span class="l-Scalar-Plain">loadBalancerSourceRanges</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="s">&quot;1.2.3.4/32&quot;</span> <span class="c1"># App1's address</span>
  <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">TCP</span>
    <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span> <span class="c1"># Redirect traffic hitting 80 to the app's service port</span>
    <span class="l-Scalar-Plain">targetPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080</span>
<span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>

<span class="nn">---</span>

<span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Ingress</span>
<span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
<span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">restaurant-proxy</span>
<span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
<span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myapp-proxy.somehost.net</span>
  <span class="l-Scalar-Plain">http</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">paths</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/</span>
        <span class="l-Scalar-Plain">backend</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">serviceName</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myapp-proxy</span>
          <span class="l-Scalar-Plain">servicePort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
<span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">extensions/v1beta1</span>
</pre>
<div class="section" id="endpoints">
<h2>Endpoints</h2>
<p>Endpoints are the Kubernetes abstraction for IPs+Ports running the same application.
It's how you group together N instances of an app into one pool.</p>
<p>Under the hood Endpoints get created as a pre-requisite for every Service you deploy.
You don't usually need to deal with these directly as they are created implicitly whenever a Deployment gets applied.</p>
<p>By manually creating an endpoint we have imported our non-kubernetes app into Kubernetes.
That means we can do Kubernetes things with it like expose it via a Service or even put it behind an Ingress
Pretty neat!</p>
</div>
<div class="section" id="service">
<h2>Service</h2>
<p>Services are how we expose an endpoint to the world.
Most cloud providers will give you a public IP address for a service and load balance across all of that service's endpoints.</p>
<p>This is as far as we need to proxy traffic between our two Apps.
App1 makes a request to whatever IP Kubernetes gets for the <cite>myapp-proxy</cite> Service and relays it to the <cite>myapp-proxy</cite> endpoint, which ultimately routes the traffic to App2.
What's really cool is that the endpoint that <strong>is</strong> App2 can be an self-hosted Virtual Machine, as long as the IP doesn't change this proxy will continue to work.</p>
</div>
<div class="section" id="ingress">
<h2>Ingress</h2>
<p>Ingresses are my favorite part of Kubernetes.
They're very convenient, incredibly powerful, and they work like... over half the time.</p>
<p>While not strictly necessary, this Ingress gives us some nice-to-haves.</p>
<ul class="simple">
<li>Gives us an easy to manage host name via something like <a class="reference external" href="https://github.com/kubernetes-incubator/external-dns">External DNS</a>.</li>
<li>Could be extended to terminate SSL, again &quot;for free&quot;, with something like <a class="reference external" href="https://github.com/jetstack/cert-manager">Cert Manager</a>.</li>
</ul>
<p>So that's how we use Kubernetes to manage services (lower-case 's') which aren't running in Pods.</p>
</div>
            </article>
                <section id="article-list">
                    <h2>All posts</h2>
                    <ol>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./tech/chef-dynamic-attributes" rel="bookmark" title="Permalink to Dynamic Attributes in Chef">Dynamic Attributes in Chef</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./personal/i-fucking-graduated" rel="bookmark" title="Permalink to I. Fucking. Graduated.">I. Fucking. Graduated.</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./crypto/independent-crypto-conclusion" rel="bookmark" title="Permalink to Independent Crypto Conclusion">Independent Crypto Conclusion</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./crypto/remote-timing-attacks" rel="bookmark" title="Permalink to Remote Timing Attacks">Remote Timing Attacks</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./crypto/garbled-circuits" rel="bookmark" title="Permalink to Garbled Circuits">Garbled Circuits</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./crypto/memory-hard-functions" rel="bookmark" title="Permalink to Memory Hard Functions">Memory Hard Functions</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./crypto/elliptic-curve-cryptography" rel="bookmark" title="Permalink to Elliptic Curve Cryptography">Elliptic Curve Cryptography</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./crypto/independent-crypto-course-syllabus" rel="bookmark" title="Permalink to Independent Crypto Course syllabus">Independent Crypto Course syllabus</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./tech/buildbot-on-kubernetes" rel="bookmark" title="Permalink to Deploying Buildbot on Kubernetes">Deploying Buildbot on Kubernetes</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./creative-writing/lady-wangle" rel="bookmark" title="Permalink to Lady Wangle">Lady Wangle</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./creative-writing/paperweight-on-my-shoulders" rel="bookmark" title="Permalink to Paperweight on my shoulders">Paperweight on my shoulders</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./op-ed/self-censorship-and-social-justice" rel="bookmark" title="Permalink to Self Censorship and the Social Justice Warrior">Self Censorship and the Social Justice Warrior</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./tech/programming-hurdles" rel="bookmark" title="Permalink to Conceptual hurdles in programming">Conceptual hurdles in programming</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./creative-writing/the-moonstone-discovery" rel="bookmark" title="Permalink to The MoonStone discovery">The MoonStone discovery</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./tech/git-does-a-lot-of-things" rel="bookmark" title="Permalink to Git Does a Lot of Things">Git Does a Lot of Things</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./comics/induction" rel="bookmark" title="Permalink to Induction">Induction</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./creative-writing/debra-the-ghoul" rel="bookmark" title="Permalink to Debra the ghoul">Debra the ghoul</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./creative-writing/emperor-stan-of-stantinople" rel="bookmark" title="Permalink to Emperor Stan of Stantinople">Emperor Stan of Stantinople</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./creative-writing/the-try-new-things-couple" rel="bookmark" title="Permalink to Character Study: The 'try new things' couple">Character Study: The 'try new things' couple</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./tech/python-exceptions" rel="bookmark" title="Permalink to How to Get the Most out of Your Python Exceptions">How to Get the Most out of Your Python Exceptions</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./tech/how-to-develop-a-site-for-the-web" rel="bookmark" title="Permalink to How to develop a site for the web">How to develop a site for the web</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./tech/running-firefox-in-docker" rel="bookmark" title="Permalink to Running Firefox in Docker">Running Firefox in Docker</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./events/cat-barcamp-2015" rel="bookmark" title="Permalink to CatBarcamp 2015">CatBarcamp 2015</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./tech/covertly-install-packages-with-docker" rel="bookmark" title="Permalink to Covertly Installing Packages with Docker">Covertly Installing Packages with Docker</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-09-03" rel="bookmark" title="Permalink to Travel travel travel...">Travel travel travel...</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-09-02" rel="bookmark" title="Permalink to A Personal Day in Prague: (Almost) Just Pictures*">A Personal Day in Prague: (Almost) Just Pictures*</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-09-01" rel="bookmark" title="Permalink to Write the Docs Day 2">Write the Docs Day 2</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-08-31" rel="bookmark" title="Permalink to Write the Docs Day 1">Write the Docs Day 1</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-08-30" rel="bookmark" title="Permalink to Prague Day 1">Prague Day 1</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-08-29" rel="bookmark" title="Permalink to To Prague!">To Prague!</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-08-28" rel="bookmark" title="Permalink to A very long bike ride">A very long bike ride</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-08-27" rel="bookmark" title="Permalink to Van Vough museum">Van Vough museum</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-08-26" rel="bookmark" title="Permalink to The Rijks museum and travel tips">The Rijks museum and travel tips</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-08-25" rel="bookmark" title="Permalink to To Amsterdam!">To Amsterdam!</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-08-23" rel="bookmark" title="Permalink to Packed and Ready to Fly">Packed and Ready to Fly</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-08-02" rel="bookmark" title="Permalink to Dominos are setup">Dominos are setup</a></li>
    </ol>
    </section><!-- #article-list -->
        

 
            <li><a href="./europe-2015/2015-08-01" rel="bookmark" title="Permalink to About the blog (this is a test)">About the blog (this is a test)</a></li>
    </ol>
    </section><!-- #article-list -->

        <footer>
            <nav>
                <ul>
                    <li><a href="./about/">About</a> ::</li>
                    <li><a href="./contact/">Contact</a></li>
                    <li>:: <a href="./categories.html">Categories</a></li>
                    <li>:: <a href="./tags.html">Tags</a></li>
                </ul>
                </nav>
				<p>
					<span id="copyright">
						Creative Commons Attribution 4.0 International License<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png"></a>
					</span>
					<span id="banter">
						This website made with locally sourced bits,
						hand crafted with Python 🐍 via Pelican 🐦,
						developed on Linux 🐧,
						deployed with containers 📦,
						and hosted on clouds ⛅.
					</span>
				</p>
				<p id="theme-credit">
					<a href="http://mathieu.agopian.info/mnmlist/theme.html">Thème mnmlist</a>
					(Well... a fork, but close)
				</p>
        </footer>

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-48615202-3");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>